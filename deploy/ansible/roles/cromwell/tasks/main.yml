---
- name: apt install
  become: true
  apt:
    state: latest
    update_cache: yes
    name:
      - python3
      - python3-pip
      - python-pip
      - python3-setuptools
      - python-setuptools
      - python-docker
      - python3-pymysql
      - python-pymysql

- name: pip install
  ansible.builtin.pip:
    name: docker-py

- name: install mariadb
  become: true
  apt:
    state: latest
    update_cache: yes
    name:
      - mariadb-server
      - python-mysqldb

- name: setting database facts
  ansible.builtin.set_fact:
    db_user: "cromwell"
    db_name: "cromwell"
    db_host: "localhost"
    cromwell_zone: "europe-west1-b"
    cromwell_project: "{{ cromwell_project }}"
    cromwell_task_zone: "TODO array"
    cromwell_bucket: "{{ cromwell_bucket }}"
    docker_image: "{{ docker_image | default('broadinstitute/cromwell:84-dbe3a31') }}"
    docker_name: "cromwell"
    db_password: "{{ lookup('password', '/dev/null length=15 chars=ascii_letters') }}"


- name: template mysql configuration
  become: yes
  template:
    src: roles/cromwell/templates/my.cnf
    dest: /root/.my.cnf
    owner: root
    group: root

- name: Create a new database with name 'cromwell'
  community.mysql.mysql_db:
    name: "{{ db_name }}"
    login_host: 'localhost'
    login_user: 'root'
    login_password: ''
    state: present

- name: Create user with password, all database privileges
  community.mysql.mysql_user:
    state: present
    name: "{{db_user}}"
    host: localhost
    password: "{{db_password}}"
    priv:
      "{{ db_name }}.*:ALL"

- name: add group cromwell
  become: yes
  group:
    name: cromwell
    state: present

- name: install docker
  become: true
  apt:
    state: latest
    update_cache: yes
    name:
      - default-jdk
      - apt-transport-https
      - ca-certificates
      - wget
      - software-properties-common
      - gnupg2
      - curl

- name: Add apt signing key from official docker repo
  become: true
  apt_key:
    url: https://download.docker.com/linux/debian/gpg
    state: present

- name: Add docker official repository for Debian Stretch
  become: true
  apt_repository:
    repo: deb [arch=amd64] https://download.docker.com/linux/debian stretch stable
    state: present

- name: Index new repo into the cache
  become: true
  apt:
    name: "*"
    state: latest
    update_cache: yes
    force_apt_get: yes

- name: actually install docker
  become: true
  apt:
    name: "docker-ce"
    state: latest

- name: add group cromwell
  become: yes
  user:
    name: cromwell
    groups: cromwell,docker
    state: present

- name: Creates cromwell root directory
  file:
    path: /opt/cromwell
    state: directory

- name: Creates directory
  file:
    path: "{{item}}"
    state: directory
  with_items:
    - /opt/cromwell/cromwell-working-dir/cromwell-executions
    - /opt/cromwell/app-config

- name: template configuration
  become: yes
  template:
    src: roles/cromwell/templates/application.conf.j2
    dest: /opt/cromwell/app-config/cromwell-application.conf
    owner: cromwell
    group: cromwell

- name: create a data container
  community.docker.docker_container:
    name: "{{docker_name}}"
    image: "{{docker_image}}"
    restart_policy: "on-failure"
    restart_retries: 10
    network_mode: host
    volumes:
      - "/opt/cromwell/app-config:/app-config"
      - "/opt/cromwell/cromwell-working-dir/cromwell-executions:/cromwell-working-dir/cromwell-executions"
    ports:
      - "80:8000"
    entrypoint:
      - /opt/java/openjdk/bin/java
      - -Xmx8G
      - -Dconfig.file=/app-config/cromwell-application.conf
      - -jar
      - /app/cromwell.jar
      - server
