{% extends "layout.html" %}


{% block in_head %}
<script type="text/javascript">
  window.model = window.model || {}; //TODO: move all properties into window.model
  window.pheno = {{ pheno|tojson|safe }};
  window.significant_phenos = {{ significant_phenos|tojson|safe }};
  window.gene_symbol = {{ gene_symbol|tojson|safe }};
  window.model.tooltip_lztemplate = {{ tooltip_lztemplate|tojson }};
  window.gene_pheno_export_fields = {{ gene_pheno_export_fields|tojson }};
</script>
<script src="{{ url_for('static', filename='vendor/locuszoom-0.5.6.vendor.min.js') }}" type="text/javascript"></script>
<script src="{{ url_for('static', filename='vendor/locuszoom-0.5.6.app.js') }}" type="text/javascript"></script>
<link  href="{{ url_for('static', filename='vendor/locuszoom-0.5.6-locuszoom.css') }}" rel="stylesheet" type="text/css">
<script src="{{ url_for('static', filename='vendor/stream_table-1.1.1.mod.min.js') }}" type="text/javascript"></script>
<script src="{{ url_for('static', filename='gene_locusview.js') }}" type="text/javascript"></script>
<script src="{{ url_for('static', filename='gene.js') }}" type="text/javascript"></script>
<link  href="{{ url_for('static', filename='gene_locusview.css') }}" rel="stylesheet" type="text/css">
{% endblock %}


{% block contained %}
<div class="row">
  <div class="col-xs-12">
    <h1 style="margin-top:0">{{ gene_symbol }}</h1>
  </div>
</div>

<div class="row">
  <div class="col-xs-12">
    <p id="gene-description"></p>
    <p id="gene-summary"></p>
    <p>
    <span>See gene in</span>
    <span id="omim-link"><a target="_blank" href="https://www.omim.org/search/?index=entry&sort=score+desc%2C+prefix_sort+desc&start=1&limit=10&search={{ gene_symbol }}">OMIM</a>, </span>
    <span id="gtex-link"><a target="_blank" href="https://www.gtexportal.org/home/eqtls/byGene?tissueName=All&geneId={{ gene_symbol }}">GTEx</a></span>
    <span id="gnomad-link"></span>
    </p>
  </div>
</div>

{% if significant_phenos %}
<div class="row">
  <div class="col-md-10 col-lg-10 col-sm-10 col-xs-10">
    <h3>FinnGen association results</h3>
  </div>
</div>
<div class="row">
  <div class="col-xs-12 col-sm-8 col-md-6">
    <input type="text" class="form-control" id="search" placeholder="Search... &quot;coronary&quot;, &quot;nervous system&quot;, etc.">
  </div>
  <div class="col-xs-12 col-sm-4 col-sm-6">
    <h5 class="pull-right"><div id="streamtable-found" class="label label-primary"></div></h5>
  </div>
</div>
      <div class="row stream_table_row">
        <div class="col-xs-12">
          <table id="stream_table" class="table table-striped table-bordered">
            <thead>
              <tr>
                <th style="width: 7%;">p-value</th>
                <th style="width: 15%;">variant</th>
                <th>phenotype</th>
                <th>category</th>
                <th style="width: 7%;">number of cases</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
          <div class='btn' style='padding-left: 0px'>
              <a class='dl-link btn-primary btn' href="#" id ="export" role='button'> Download table data as TSV
              </a>
          </div>
        </div>
      </div>
<br>
{% endif %}
{% for key in ['num_cases', 'num_controls', 'num_samples'] %}
 {% if key in pheno %}
  {% if '<' in pheno[key]|string %}
    <div class="alert alert-danger" role="alert"><b>Warning:</b> This phenotype has {{ pheno[key] }} {{ key.replace('num_','') }}.</div>
  {% elif 0 < pheno[key]|int < 200 %}
    <div class="alert alert-danger" role="alert"><b>Warning:</b> This phenotype only has {{ pheno[key] }} {{ key.replace('num_', '') }}.</div>
  {% endif %}
 {% endif %}
{% endfor %}
<div class="row">
    <div class="pheno-info col-xs-12">
      <p style="margin-bottom: 0"><b>{{ pheno.phenostring }}</b></p>
        {% if 'num_cases' in pheno %}
          <p style="margin-bottom: 0"><b>{{ pheno.num_cases }}</b> cases, <b>{{ pheno.num_controls }}</b> controls</p>
        {% elif 'num_samples' in pheno %}
          <p style="margin-bottom: 0"><b>{{ pheno.num_samples }}</b> samples</p>
        {% endif %}
        {% if pheno.category %}
          <p style="margin-bottom: 0">{{ pheno.category}}</p>
        {% endif %}
    </div>
</div>
<br>

<div class="row">
  <div class="col-md-10 col-lg-10 col-sm-10 col-xs-10">
    <div id="lz-1" class="lz-locuszoom-container lz-container-responsive" data-region={{ region }}></div>
  </div>
</div>

<div class="row">
  <div class="col-md-10 col-lg-10 col-sm-10 col-xs-10">
    <h3>Loss of function and missense variants</h3>
</div>
</div>
<div class="row stream_table_row">
  <div class="col-xs-12 functional_variants">
    <table id="stream_table_functional_variants" class="table table-striped table-bordered">
      <thead>
        <tr>
          <th style="width: 10%; user-select: none;">variant</th>
          <th style="width: 15%; cursor: pointer; user-select: none;" data-sort="most_severe:asc">consequence</th>
          <th style="width: 5%; cursor: pointer; user-select: none;" data-sort="info:desc">info</th>
          <th style="width: 7%; cursor: pointer; user-select: none;" data-sort="maf:desc">maf</th>
          <th style="user-select: none;">FinnGen phenotypes p < 10-4</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
    <!-- <div class='btn'> -->
    <!--     <a class='dl-link btn-primary btn' href="#" id ="export" role='button'> Download table data as TSV -->
    <!--     </a> -->
    <!-- </div> -->
  </div>
</div>
   
<script type="text/template" id="streamtable-template">
  <% if (p.pheno.phenocode === pheno.phenocode) { %>
  <tr style="background-color:rgb(247,245,230)">
    <td><%= p.assoc.pval.toExponential(1) %></td>
    <td><a style="color:black" href="/variant/<%= variant_id_to_pheweb_format(p.assoc.id) %>">
	<%= p.assoc.rsids ? p.assoc.rsids : (p.assoc.id.length > 20) ? p.assoc.id.substring(0, 17) + '...' : p.assoc.id %>
    </a></td>
    <td><%= p.pheno.phenostring || p.pheno.phenocode %></td>
    <td><%= p.pheno.category || 'Unknown' %></td>
    <td style="text-align: right;"><%= p.pheno.num_cases %></td>
  </tr>
  <% } else { %>
  <tr>
    <td><%= p.assoc.pval.toExponential(1) %></td>
    <td><a style="color:black" href="/variant/<%= variant_id_to_pheweb_format(p.assoc.id) %>">
	<%= p.assoc.rsids ? p.assoc.rsids : (p.assoc.id.length > 20) ? p.assoc.id.substring(0, 17) + '...' : p.assoc.id %>
    </a></td>
    <td><a style="color:black" href="/region/<%= p.pheno.phenocode %>/gene/<%= gene_symbol %>">
        <%= p.pheno.phenostring || p.pheno.phenocode %>
    </a></td>
    <td><%= p.pheno.category || 'Unknown' %></td>
    <td style="text-align: right;"><%= p.pheno.num_cases %></td>
  </tr>
  <% } %>
</script>

<script type="text/template" id="streamtable-functional-variants-template">
  <tr>
    <td><a style="color:black" href="/variant/<%= variant_id_to_pheweb_format(v.id) %>">
	<%= v.rsids || v.id %>
    </a></td>
    <td><%= v.most_severe.replace(/_/g, ' ').replace(' variant', '') %></td>
    <td><%= v.info.toPrecision(3) %></td>
    <td><%= v.maf < 0.01 ? v.maf.toExponential(1) : v.maf.toPrecision(2) %></td>
    <td><%= v.significant_phenos
	    .sort(function(pheno1, pheno2) { return pheno1.assoc.pval - pheno2.assoc.pval })
	    .map(function(pheno) {
	        return '<a style="color:black" href="/pheno/' + pheno.pheno.phenocode + '">' +
                    '<span style="display: inline-block; width: 70px">' +
	            pheno.assoc.pval.toExponential(1) + 
	            '</span><span>' +
	            pheno.pheno.phenostring +
	            '</span></a>';
	    }).join('<br/>') %>
    </td>
  </tr>
</script>

{% endblock %}
